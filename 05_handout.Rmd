---
title: | 
  | \includegraphics{logotip.pdf}
  |
  | KOSTAT-UNFPA Summer Seminar on Population
  | \vspace{1.5cm} \LARGE \emph{Workshop~1.~Demography in R}
  | \vspace{0.3cm} \huge \textbf{Day 5: Advanced pipelines}\vspace{0.6cm}
  | 
fontsize: 11pt
geometry: a4paper, twoside, left=2.5cm, right=2.5cm, top=2cm, bottom=2.8cm, headsep
  = 1.35cm, footskip = 1.6cm
output:
  pdf_document:
    number_sections: yes
  html_document2: default
  html_document:
    number_sections: yes
    toc: yes
  pdf_document2: default
  header-includes:
    - \usepackage{titling}
    - \usepackage{fancyhdr}
    - \pagestyle{fancy}
    - \fancyhead[LE]{\thepage~\qquad~KOSTAT-UNFPA Summer Seminar on Population}
    - \fancyhead[RE]{Workshop~1.~Demography in R}
    - \fancyhead[LO]{{Day 5: Advanced pipelines}}
    - \fancyhead[RO]{Tim Riffe\qquad~\thepage}
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\noindent\makebox[\textwidth][c]{
  \begin{minipage}[t]{0.45\textwidth}
    \centering
    \Large{Instructor: Tim Riffe} \\
    \vspace{0.1cm}\large{\texttt{tim.riffe@gmail.com}}
   
    \vspace{.5cm}
    \Large{Assistant: Rustam Tursun-Zade}
    \vspace{0.1cm}\large{\texttt{rustam.tursunzade@gmail.com}}
  \end{minipage}
}


\vspace{0.8cm}
\begin{center}
\large{30 July 2021}
\end{center}
\vspace{0.8cm}


\tableofcontents


# Downloading data

One of the Monday exercises was to vote on data to use for today, Friday. I'll go with whatever signal I get. Eight votes were cast:

* Human Lifetable Database (3)
* World Values Survey (2)
* Global Burden of Disease (2)
* Human Mortality Database (1)

Based on this, I've decided to try and combine data from the Human Lifetable Database (HLD) and Global Burden of Disease (GBD) 2017 version.

## GBD
Download the GBD data selection I made, which consists in all countries and territories in 2017 by abridged ages and sex, and gives the prevalence of four conditions. The data selection was made from this webpage: [https://gbd2017.healthdata.org/gbd-search/](https://gbd2017.healthdata.org/gbd-search/), which looks like this:

\begin{center}
\includegraphics[]{GBDscreenshot.png}
\end{center}

My selections were:

* Base: `single`
* Location: `all countries and territories`
* Year: `2017`
* Context: `Cause`
* Age: manual selection of 0, 1-4, 5-9 ...
* Metric: `percent`
* Measure: `prevalence`
* Sex: `Male`, `Female`, `Both`
* Cause: `Total All causes`, `B.2.6 Cardiomyopathy and myocarditis`, `B.4 Digestive diseases`, ``B.8 Diabetes and kidney diseases`

I then clicked `permalink`. They generate the file, and then send an email when it's ready. This is the location they sent me to: [https://gbd2017.healthdata.org/gbd-search/result/835b25c27d7b31e221f6c51f7756875b](https://gbd2017.healthdata.org/gbd-search/result/835b25c27d7b31e221f6c51f7756875b), which, if true to the name *perma*link this ought to be available for a reasonably long period of time...

This is what it looks like:
\begin{center}
\includegraphics[]{GBDscreenshot2.png}
\end{center}

I right-clicked where it says `IHME data download #1` and selected `copy link address`. Said link is what you see used in the following code chunk, which downloads the data as a zip file called `GBD_prevalence.zip` and sticks it in our `Data` folder. Before downloading, we check that we haven't already downloaded it using `if(file.exists())`. Make sense? We don't want to download over and over. What you see in the `{}` is the body of code subject to the `if` condition. That's how conditional code works ;-)

```{r}
GBD_url <- "https://s3.healthdata.org/gbd-api-2017-public/835b25c27d7b31e221f6c51f7756875b_files/IHME-GBD_2017_DATA-835b25c2-1.zip"
local_file <- here::here("Data","GBD_prevalence.zip")
# Only download the file once!
if (!file.exists(local_file)){
  download.file(GBD_url, destfile = local_file)
}
```
The zip file contains a suggested citation (@network2018global) and a csv that can be read directly with `readr::`read_csv()`:

```{r}
library(tidyverse)
library(readr)
GBD  <- read_csv(local_file)
glimpse(GBD)
```

This is a rather tidy dataset already, so this saves us lots of work :-)

Let's first change the `age` coding to integer lower bounds. Again, there might be many strategies to do this. What I did was to look at the unique values `GBD %>% pull(age) %>% unique()`. I noticed the pattern that the lower age bound was always contained in the first two characters, which I extract using `substr()`. At this point `age` is almost ready for `parse_number()`, except age 0 is left at `"<1"`, so we handle it first using `ifelse()`. We can take care to recode `sex` at the same time, using `case_when()`.
```{r}
GBD <-
  GBD %>% 
  mutate(age = substr(age, start = 1, stop = 2),
         age = ifelse(age == "<1", "0", age),
         age = parse_number(age),
         sex = case_when(sex == "Male" ~ "m",
                         sex == "Female" ~ "f",
                         sex == "Both" ~ "t")) 
```

Now let's have a preliminary look at some prevalence age patterns. Since the data have confidence intervals, I'll go ahead and add on the confidence bands to get a sense of it.
```{r}
GBD %>% 
  filter(location == "Ghana") %>% 
  ggplot(aes(x = age, y = val, color = sex)) +
  geom_line() +
  geom_ribbon(aes(ymin = lower, 
                  ymax = upper, 
                  fill = sex), 
              alpha = .2, 
              color = NA) +
  facet_wrap(~cause)
```

From this picture, I think we can definitely delete `"All causes"`, which apparently contains no useful information. I have no instincts of background knowledge on `Cardiomyopathy and myocarditis`, but it seems harmless to keep it for now.

```{r}
GBD <- GBD %>% 
  filter(cause != "All causes")
```

We'll see how to handle country codes when we see what the codes and country names are for HLD data

## HLD

The Human Lifetable Database [https://www.lifetable.de/cgi-bin/index.php](https://www.lifetable.de/cgi-bin/index.php) is the lesser-know cousin of the Human Mortality Database, and it is subject to irregular updates. This database does not estimate its own lifetables. Instead it collates lifetables from many sources and harmonizes them to a standard form, at times necessitating recalculation. Lifetables in this database are exclusively based on vital registration, but may have been subject to various kinds of adjustment from the original producers. For years I never saw anyone use this database in research, and I suspect this is because it required lots of manual clicking to get all the files. Now they offer a pooled data file. Let's get it!

```{r}
HLD_url <- "https://www.lifetable.de/data/hld.zip"

HLD_local_file <- here::here("Data","HLD.zip")
if (!exists(HLD_local_file)){
  download.file(HLD_url, destfile = HLD_local_file)
}

```
It's rather straightforward to get this into `R` using `read_csv()`. It doesn't even matter that the contents of the zip file don't have a file extension!
```{r}
HLD <- read_csv(HLD_local_file)
```
# Harmonize to join

These data include quite a large range of years. Since GBD data is just 2017 in what I downloaded, let's first filter HLD down to data just after, say, 2012. Now, for each country, we should try to select the year closest to 2017. We also filter down to just national data (no subpopulations). This filtering routine took some iteration to derive to make sure there was just one lifetable per `Country` and `Sex`. 

```{r}
HLD <-
  HLD %>% 
  filter(Ethnicity == "0",
         Residence == "0",
         Region == "0",
         TypeLT > 1,
         Year1 >= 2012) %>% 
  mutate(Year = (Year1 + Year2 + 1) / 2,
         Diff = 2017.5 - Year,
         Dist = abs(Diff)) %>% 
  group_by(Country, Sex) %>% 
  mutate(keep = Dist == min(Dist)) %>% 
  # if a country has 2016 and 2018 but no 2017, then take 2018?
  group_by(Country, Sex, keep) %>% 
  mutate(keep2 = keep & Year == max(Year)) %>% 
  ungroup() %>% 
  filter(keep2) %>% 
  select(ISO3 = Country, sex = Sex, age = Age, nLx = `L(x)`) %>% 
  mutate(sex = ifelse(sex == 1, "m", "f")) 

```

On inspection, we learn that the HLD data only has males and females, so we can safely remove total sex from the GBD data. Finally, let's derive ISO3 country codes from the GBD names.


```{r}
# install.packages("countrycode")
library(countrycode)
GBD <- GBD %>% 
  filter(sex != "t") %>% 
  mutate(ISO3 = countryname(location, destination = "iso3c")) %>% 
  arrange(location, sex, cause, age)
```

## Join the datasets!
This was satisfyingly little upfront work to get ready to join. Double-checking: We have the same sex codes, the same age classes (open ages not checked, not essential here), and the same ISO3 codes. I think an inner join will get the job done. Note, since in the GBD data we have 3 causes per `age`-`sex`-`year`-`location` combination, `Lx` will be repeated for each of them. It appears we can calculate a few kinds of healthy life expectancy using the Sullivan method (@sullivan1971single), how exciting!

```{r}
DAT <-
  inner_join(GBD, HLD, by = c("ISO3", "sex", "age"))

DAT %>% pull(location) %>% unique()
```

# Calculate HLE

Healthy life expectancy is the sum product of lifetable survivorship and the compliment of a poor health prevalence indicator.
```{r}
HLE <-
  DAT %>% 
  mutate(nLx = nLx / 1e5,
         Hx = nLx * (1 - val),
         Hx_lower = nLx * (1 - upper),
         Hx_upper = nLx * (1 - lower)) %>% 
  group_by(location, sex, cause) %>% 
  summarize(LE = sum(nLx),
            HLE = sum(Hx),
            HLE_upper = sum(Hx_upper),
            HLE_lower = sum(Hx_lower),
            .groups = "drop")
```

# Visualize HLE in a dotplot?

```{r, fig.width=8, fig.height=14}
HLE$cause %>% unique()
HLE %>% 
  filter(cause == "Diabetes and kidney diseases") %>% 
  ggplot(aes(x = HLE, y = reorder(location, HLE), color = sex)) +
           geom_point(position = position_dodge2(width = .4, reverse = TRUE)) +
           geom_pointrange(aes(xmin = HLE_lower, xmax = HLE_upper),
                           position = position_dodge2(width = .4, reverse = TRUE)) +
  geom_point(data = filter(HLE, cause == "Diabetes and kidney diseases"),
             mapping = aes(x = LE, y = reorder(location, HLE), color = sex),
             shape = 2) +
  xlim(47,85) +
  labs(y = "",
       x = "Heathy life expectancy")
```


